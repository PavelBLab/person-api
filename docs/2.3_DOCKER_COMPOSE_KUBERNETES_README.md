# **Person API Kubernetes Deployment Guide For Person Api Only**
**Important:** In this configuration Postgres database located in a separate container in docker.

This guide outlines the steps to set up, configure, and deploy the **Person API** using **Docker Compose** for local PostgreSQL setup and **Helm** for Kubernetes deployment.


## **1. Prerequisites**

Ensure the following tools are installed on your system:

- **Docker / Docker Desktop** and **Docker Compose**
- **Helm** (Kubernetes package manager)
- **Kubernetes Cluster** (local, minikube, or any K8s provider)
- **kubectl** (Kubernetes command-line tool)

---

## **2. Docker Compose for Local PostgreSQL**

Before deploying the **Person API** in Kubernetes, you need to set up a PostgreSQL database locally using Docker Compose.

### **Docker Compose Configuration**

```yaml
name: person-api-k8s

services:
  postgres:
    container_name: postgres
    image: postgres:16.4
    ports:
      - 6000:5432
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./dev-scripts/init-person-db.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      POSTGRES_DB: testcase
      POSTGRES_PASSWORD: postgres

volumes:
  postgres_data:
    external: false
```

### **Steps to Set Up Local PostgreSQL**

1. **Create Docker Compose File:**
    - Ensure the above Docker Compose YAML is saved as `docker-compose-k8s.yml` in the root of your project.

2. **Run Docker Compose:**
    - To start PostgreSQL locally, run the following command in your terminal:

   ```
   docker-compose -f docker-compose-k8s.yml up -d
   ```

3. **Access PostgreSQL:**
    - PostgreSQL will be accessible at `localhost:6000`, with the database name `testcase` and the password `postgres`.

4. **Database Initialization:**
    - The `init-person-db.sql` script located in `./dev-scripts/` will be executed automatically on container startup to initialize the database schema.

---

## **3. Helm Chart Setup for Person API**

Helm is used to deploy the **Person API** in a Kubernetes cluster. The following steps guide you through creating and deploying the Helm chart.

### **Steps to Set Up and Deploy the Helm Chart**

### **Step 1: Create a Helm Chart**

1. **Generate Helm Chart:**

   To create a new Helm chart for the **Person API**, run the following command:

   ```
   helm create abnamro-person-api-chart
   ```

   This command creates the initial structure for the Helm chart, including files like `values.yaml`, `templates/`, and other configurations.

---

### **Step 2: Configure Helm Chart Values**

1. **Edit `values.yaml` and `values-dev.yaml`:**

   Modify the `values.yaml` and `values-dev.yaml` files to configure the specific settings for your **Person API** deployment, such as environment variables, replica count, service type, and resource limits.

   Example settings in `values.yaml`:

   ```yaml
   image:
     repository: pavelbr368/abnamro-person-api
     tag: latest

   service:
     type: ClusterIP
     port: 8080

   env:
     SPRING_PROFILES_ACTIVE: dev
     SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/testcase
     SPRING_DATASOURCE_USERNAME: postgres
     SPRING_DATASOURCE_PASSWORD: postgres
   ```

   **Note:** Ensure that PostgreSQL connection details in `values.yaml` match your database setup.

---

### **Step 3: Render the Helm Templates**

1. **Render the Helm chart to files (Optional for Preview):**

   If you want to see the rendered Kubernetes manifests without applying them, use the following Helm command:

   ```
   helm template --output-dir ./output . --values=values.yaml,values-dev.yaml
   ```

   This command renders the templates using the values provided in `values.yaml` and `values-dev.yaml` and outputs the manifest files into the `./output` directory.

---

### **Step 4: Deploy the Helm Chart**

1. **Create Namespace:**

   In the terminal use the following cli command:
   ```
   kubectl create namespace person-api-dev
   ```

   Check that person-api-dev namespace successfully created:
   ```
   kubectl get namespace
   ```


2. **Deploy the Chart to Kubernetes:**

   To deploy the **Person API** to your Kubernetes cluster, use the following Helm command:

   ```
   helm upgrade --namespace person-api-dev --debug --wait --timeout=5m --values=values.yaml,values-dev.yaml --install abnamro-person-api .
   ```

   **Explanation:**
    - `--namespace person-api-dev`: Specifies the Kubernetes namespace for the deployment.
    - `--debug`: Enables detailed output for debugging.
    - `--wait --timeout=5m`: Waits for all resources to be created and ready, with a 5-minute timeout.
    - `--values=values.yaml,values-dev.yaml`: Specifies the YAML files containing the values to be used for the deployment.
    - `--install`: Installs the release if it doesnâ€™t exist yet.
    - `abnamro-person-api`: The name of the Helm release.

---

### **Step 5: Verify the Deployment**

1. **Check Pod Status:**

   After deployment, verify that the Kubernetes pods are up and running using `kubectl`:

   ```
   kubectl get pods --namespace person-api-dev
   ```

   This command lists all pods in the `person-api-dev` namespace. Ensure that all pods are in the **Running** state.

2. **Check Logs:**

   To check the logs of the **Person API** pod, use the following command:

   ```
   kubectl logs -f <person-api-pod-name> --namespace person-api-dev
   ```

---

## **4. Managing the PostgreSQL Database in Kubernetes**

To integrate the **Person API** with the PostgreSQL database in your Kubernetes cluster, ensure the following:
* **PostgreSQL Configuration:**
    - In your `values.yaml` file, make sure the database connection URL points to the correct PostgreSQL service (e.g., `jdbc:postgresql://postgres:5432/testcase`).
---


## **5. Accessing Person API and Postgres**

- Go to the browser and type below path to open **swagger**:
    ```
    http://localhost:18080/person-api-documentation
    ```
- The **Person API** will be accessible via the `person-api-service` LoadBalancer. You can retrieve the external IP using:
  ```
  kubectl get services -n person-api-test
  ```

- The **PostgreSQL** service can be accessible via PgAdmin using hostname ```localhost``` and port ```6000```.
---


## **6. Cleanup**

If you need to remove the Helm deployment and Docker Compose setup:

1. **Stop and Remove Docker Compose Containers:**

   ```
   docker-compose down
   ```

2. **Uninstall Helm Release:**

   ```
   helm uninstall abnamro-person-api --namespace person-api-dev
   ```

   This removes the Helm release but keeps any persistent data stored in the Kubernetes cluster.

---

## **7. Summary of Commands**

Here is a quick summary of the essential commands for setting up and deploying the **Person API**:

1. **Run Docker Compose for PostgreSQL:**

   ```
   docker-compose -f docker-compose-k8s.yml up -d
   ```

2. **Create Helm Chart:**

   ```
   helm create abnamro-person-api-chart
   ```

3. **Render Helm Templates (Optional):**

   ```
   helm template --output-dir ./output . --values=values.yaml,values-dev.yaml
   ```

4. **Deploy Helm Chart to Kubernetes:**

   ```
   helm upgrade --namespace person-api-dev --debug --wait --timeout=5m --values=values.yaml,values-dev.yaml --install abnamro-person-api .
   ```

5. **Check Pods in Kubernetes:**

   ```
   kubectl get pods --namespace person-api-dev
   ```

6. **Uninstall Helm Release:**

   ```
   helm uninstall abnamro-person-api --namespace person-api-dev
   ```

By following this guide, you will successfully set up and deploy the **Person API** along with PostgreSQL in a Kubernetes environment.